# Session Log — 2026-02-17

## セッション 1: ツールリンク編集機能

ダッシュボードのインターン向け「ツールリンク集」にユーザー別URL編集機能を追加。
各インターン生が自分の Notion / Slack / Backlog 等のワークスペースURLをカスタマイズし、localStorage に保存できるようにした。

### 新規ファイル

| ファイル | 内容 |
|---------|------|
| `src/data/tool-links.ts` | `ToolLink` インターフェース + `DEFAULT_TOOL_LINKS` 定数 |
| `src/hooks/useToolLinks.ts` | localStorage 管理フック（SSRセーフ） |
| `src/components/dashboard/ToolLinksEditor.tsx` | 6ツール分のURL編集モーダル |

### 修正ファイル

| ファイル | 変更内容 |
|---------|----------|
| `src/app/dashboard/page.tsx` | `useToolLinks` フック利用、編集ボタン追加 |

---

## セッション 2: 6機能一括実装 + 本番設定

計画書 (`shiny-sauteeing-pie.md`) に基づき、6つの新機能を実装。

### 実装した機能

#### Feature 0: フィードバックダッシュボード
- フィードバック送信者のニックネーム・ロール・レベル・XP・進捗率を可視化
- 集計カード（総数・平均評価・送信者数・今週の件数）
- タイプ/評価フィルター + テキスト検索

#### Feature 1: メールアドレスでアカウント登録
- Supabase Auth によるメール＋パスワード登録
- 既存の共通パスワードログインは「クイックログイン」タブとして維持
- パスワード強度インジケーター付き登録フォーム

#### Feature 2: 登録後プロフィール入力
- メール登録完了後、同一ページ内でインラインにニックネーム → ロール選択
- ステップインジケーター + スライドアニメーション

#### Feature 3: 事前学習アセスメント
- Typeform風の全画面・1問ずつ表示のスキル診断（8問）
- 選択肢ボタン押下で confetti 演出
- キーボード操作対応（1-4キー）
- beginner / intermediate / advanced の3段階判定

#### Feature 4: スキルベースのプログラム解放
- アセスメント結果 + ロールに応じて Day を事前解放
- `isDayUnlocked()` に overrides パラメータ追加
- DayCard に「スキップ可」バッジ表示

#### Feature 5: 福岡タイプ道場（タイピングミニゲーム）
- 福岡名産品＋IT用語（38語）のタイピングゲーム
- ローマ字入力判定（複数入力パターン対応）
- コンボシステム（最大5x倍率）、30s/60s/90s モード選択
- S/A/B/C/D グレード判定 + リーダーボード

### 新規ファイル (33ファイル)

| カテゴリ | ファイル |
|---------|---------|
| マイグレーション (4) | `002_add_email_auth.sql`, `003_add_assessment.sql`, `004_add_day_unlocks.sql`, `005_add_typing_scores.sql` |
| API (5) | `auth/register`, `auth/email-login`, `assessment`, `feedback/dashboard`, `typing` |
| 認証UI (5) | `LoginTabs`, `EmailLoginForm`, `EmailRegisterForm`, `ProfileSetupInline`, `StepIndicator` |
| アセスメント (5) | `assessment-questions.ts`, `assessment/page`, `AssessmentQuestion`, `AssessmentResults`, `useAssessment` |
| タイピング (10) | `typing-words.ts`, `romaji-map.ts`, `typing/page`, `TypingGame`, `TypingInput`, `ComboDisplay`, `TypingTimer`, `TypingResults`, `TypingLeaderboard`, `useTypingScores` |
| フィードバック (4) | `FeedbackDashboard`, `FeedbackStats`, `FeedbackUserCard`, `FeedbackFilters` |
| その他 (3) | `skill-unlock-map.ts`, `useUnlockOverrides`, `assessment.ts` (型) |

### 修正ファイル (10ファイル)

- `src/app/login/page.tsx` — LoginTabs + ProfileSetupInline 統合
- `src/app/dashboard/page.tsx` — アセスメントプロンプト、overrides、タイピングカード追加
- `src/app/feedback/page.tsx` — FeedbackDashboard に置き換え
- `src/middleware.ts` — 新APIパス追加
- `src/types/index.ts` — `FeedbackWithUser` 型追加、User に email/auth_id/skill_level 追加
- `src/lib/progress.ts` — `isDayUnlocked()` に overrides パラメータ追加
- `src/components/layout/Sidebar.tsx` — タイプ道場ナビリンク追加
- `src/components/layout/AppLayout.tsx` — `useUnlockOverrides` 追加
- `src/components/dashboard/DayCard.tsx` — `isSkippable` バッジ追加

### バグ修正

#### フィードバック送信エラー
- **原因**: `feedbacks` テーブルの `quest_id`, `quest_title`, `rating` が NOT NULL だが、一般フィードバックでは null を送信していた。`type` カラムも未存在
- **修正**: マイグレーション `006_fix_feedbacks_schema.sql` で nullable に変更 + `type` カラム追加
- **注意**: Supabase SQL Editor でコメント付きSQLが構文エラーになる場合あり → コメント除去で解決

#### デモモードによる Slack 通知未送信
- **原因**: `NEXT_PUBLIC_DEMO_MODE=true` のまま運用していた → API がモックレスポンスを返し Supabase/Slack に到達せず
- **修正**: `.env.local` で `NEXT_PUBLIC_DEMO_MODE=false` に変更

### 本番環境設定

- `.env.local` に実 Supabase URL/Key を設定
- `NEXT_PUBLIC_DEMO_MODE=false` に変更
- Supabase Dashboard でマイグレーション 002〜006 を実行
- main ブランチにコミット & プッシュ完了

### ビルド結果

```
npm run build — エラー 0
全46ファイル追加 (+3,137行)
```

### 残タスク

| 項目 | 状態 | メモ |
|------|------|------|
| Notion連携設定 | 未対応 | `NOTION_API_KEY` / `NOTION_FEEDBACK_DB_ID` 未設定 |
| ストリーク計算の本番実装 | 仮実装 | バックエンドでのログイン日数追跡が必要 |
| テスト追加 | 未作成 | 必要に応じて Jest/Vitest 追加 |
| Vercel デプロイ | 未確認 | 環境変数の設定が必要 |

### セッション最後の作業

- `CLAUDE.md` 作成 — プロジェクト全体のコンテキスト・アーキテクチャ・コーディング規約を記録
- セッションログ更新

---

## セッション 3: アナリティクスダッシュボード

全ユーザーがアクセス可能な `/analytics` ページを追加。recharts による12種のチャートで利用状況・学習進捗・タイピング統計・フィードバック傾向を可視化。

### 新規ファイル (14ファイル)

| カテゴリ | ファイル |
|---------|---------|
| 型定義 | `src/types/analytics.ts` |
| ユーティリティ | `src/lib/analytics-helpers.ts` — 日付バケッティング、DAU/WAU算出、WPM/進捗バケット |
| API | `src/app/api/analytics/route.ts` — 5テーブル並列クエリ + デモモードモックデータ |
| フック | `src/hooks/useAnalytics.ts` |
| ページ | `src/app/analytics/page.tsx` |
| コンポーネント (9) | `AnalyticsDashboard`, `AnalyticsHeader`, `StatsSummaryCards`, `ChartCard`, `UsageSection`, `LearningProgressSection`, `TypingStatsSection`, `FeedbackTrendsSection`, `AnalyticsEmptyState` |

### 修正ファイル (3ファイル)

| ファイル | 変更内容 |
|---------|----------|
| `src/components/layout/AppHeader.tsx` | ストリーク左にアナリティクスアイコンリンク追加（デスクトップのみ） |
| `src/components/layout/Sidebar.tsx` | `navItems` に `{ href: '/analytics', label: 'アナリティクス', emoji: '📈' }` 追加 |
| `src/components/layout/MobileNav.tsx` | 「検索」タブを「分析」に差し替え |

### チャート一覧 (recharts)

| セクション | チャート | 種別 |
|-----------|---------|------|
| 利用状況 | DAU推移 (30日) | AreaChart |
| 利用状況 | WAU推移 (12週) | BarChart |
| 利用状況 | ユーザー登録推移 | AreaChart |
| 利用状況 | ロール分布 | PieChart (ドーナツ) |
| 学習進捗 | Day別完了率 | 横BarChart |
| 学習進捗 | 進捗分布 | PieChart |
| タイピング | モード別平均スコア/WPM | GroupedBar |
| タイピング | WPM分布 | BarChart |
| タイピング | デイリープレイ数 | AreaChart |
| フィードバック | 評価分布 | 横BarChart |
| フィードバック | 週別投稿数 | StackedBar |
| フィードバック | 平均評価推移 | LineChart |

### 依存関係追加

- `recharts` (npm install)

### ビルド結果

```
npm run build — エラー 0
19ファイル変更 (+1,720行)
```

### セッション最後の作業

- `CLAUDE.md` 更新 — アナリティクス機能の情報を追記
- セッションログ更新
- main ブランチにコミット & プッシュ完了
